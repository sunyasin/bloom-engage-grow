generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

enum community_type {
  shop
  gallery
  course

  @@schema("public")
}

enum membership_status {
  active
  canceled
  expired
  trial

  @@schema("public")
}

enum renewal_period {
  monthly
  yearly
  lifetime

  @@schema("public")
}

enum payment_status {
  pending
  paid
  failed
  refunded
  succeeded
  canceled

  @@schema("public")
}

model communities {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  slug                String?               @unique
  description         String?
  type                community_type        @default(course)
  creator_id          String?               @db.Uuid
  owner_id            String?               @db.Uuid
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  updated_at          DateTime              @default(now()) @db.Timestamptz(6)
  subscription_tiers  subscription_tiers[]
  memberships         memberships[]
  transactions        transactions[]
  payouts             community_payouts[]
  gallery_collections gallery_collections[]

  @@map("communities")
  @@schema("public")
}

model subscription_tiers {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  community_id    String        @db.Uuid
  name            String
  slug            String
  description     String?
  price_monthly   Decimal?      @default(0) @db.Decimal(10, 2)
  price_yearly    Decimal?      @default(0) @db.Decimal(10, 2)
  currency        String        @default("RUB")
  is_free         Boolean       @default(false)
  is_active       Boolean       @default(true)
  sort_order      Int           @default(0)
  tier_id         Int           @default(autoincrement())
  features        Json?         @default("[]")
  created_at      DateTime      @default(now()) @db.Timestamptz(6)
  updated_at      DateTime      @default(now()) @db.Timestamptz(6)
  moderated_at    DateTime?     @db.Timestamptz(6)

  community       communities   @relation(fields: [community_id], references: [id], onDelete: Cascade)
  memberships     memberships[]
  transactions    transactions[]

  @@unique([community_id, slug])
  @@map("subscription_tiers")
  @@schema("public")
}

model memberships {
  id                       String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                  String              @db.Uuid
  community_id             String              @db.Uuid
  subscription_tier_id     String?             @db.Uuid
  status                   membership_status   @default(active)
  started_at               DateTime            @default(now()) @db.Timestamptz(6)
  expires_at               DateTime?           @db.Timestamptz(6)
  renewal_period           renewal_period      @default(monthly)
  external_subscription_id String?
  created_at               DateTime            @default(now()) @db.Timestamptz(6)
  updated_at               DateTime            @default(now()) @db.Timestamptz(6)

  community                communities         @relation(fields: [community_id], references: [id], onDelete: Cascade)
  subscription_tier        subscription_tiers? @relation(fields: [subscription_tier_id], references: [id], onDelete: SetNull)

  @@unique([user_id, community_id])
  @@map("memberships")
  @@schema("public")
}

model transactions {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id              String              @db.Uuid
  course_id            String?             @db.Uuid
  community_id         String?             @db.Uuid
  subscription_tier_id String?             @db.Uuid
  payout_id            String?             @db.Uuid
  amount               Decimal             @db.Decimal(10, 2)
  currency             String              @default("RUB")
  payment_method       String?
  status               payment_status      @default(pending)
  provider             String?             @default("yookassa")
  provider_payment_id  String?
  idempotency_key      String?             @unique
  description          String?
  metadata             Json?
  created_at           DateTime            @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?           @default(now()) @db.Timestamptz(6)

  community            communities?        @relation(fields: [community_id], references: [id], onDelete: SetNull)
  subscription_tier    subscription_tiers? @relation(fields: [subscription_tier_id], references: [id], onDelete: SetNull)
  payout               community_payouts?  @relation(fields: [payout_id], references: [id], onDelete: SetNull)

  @@index([provider_payment_id], map: "idx_transactions_provider_payment_id")
  @@index([user_id], map: "idx_transactions_user_id")
  @@index([status], map: "idx_transactions_status")
  @@index([payout_id], map: "idx_transactions_payout_id")
  @@map("transactions")
  @@schema("public")
}

model community_payouts {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Автор выплаты
  author_id           String              @db.Uuid

  // Сообщество, за которое начислена выплата
  community_id        String              @db.Uuid

  // Период, за который начислена выплата
  period_start        DateTime            @db.Timestamptz
  period_end          DateTime            @db.Timestamptz

  // Сумма выплаты
  amount              Decimal             @db.Decimal(10, 2)
  currency            String              @default("RUB")

  // Способ выплаты
  payout_method       String?

  // Реквизиты/кошелек для выплаты
  payout_details      Json?

  // Bucket для хранения квитанции
  receipt_bucket      String?             @default("payout-receipts")

  // Путь к файлу квитанции в storage
  receipt_path        String?

  // Комментарий администратора
  admin_comment       String?

  // Метаданные
  metadata            Json?

  // Timestamps
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  updated_at          DateTime            @default(now()) @db.Timestamptz(6)
  paid_at             DateTime?           @db.Timestamptz(6)

  // Связь с сообществом
  community           communities         @relation(fields: [community_id], references: [id], onDelete: Cascade)

  // Связанные транзакции
  transactions        transactions[]

  @@index([author_id], map: "idx_payouts_author_id")
  @@index([community_id], map: "idx_payouts_community_id")
  @@index([created_at], map: "idx_payouts_created_at")
  @@map("community_payouts")
  @@schema("public")
}

// Сборник - коллекция фото и постов
model gallery_collections {
  id            BigInt            @id @default(autoincrement())
  name          String
  year          Int               @default(dbgenerated("EXTRACT(YEAR FROM CURRENT_DATE)"))
  thumbnail_url String?
  audio_url     String?
  audio_filename String?
  slideshow_speed Int              @default(5)
  community_id  String?           @db.Uuid
  user_id       String            @db.Uuid
  created_at    DateTime          @default(now()) @db.Timestamptz(6)
  updated_at    DateTime          @default(now()) @db.Timestamptz(6)

  community     communities?     @relation(fields: [community_id], references: [id], onDelete: SetNull)
  posts         gallery_posts[]
  photos        gallery_photos[]
  audio         gallery_audio[]

  @@index([user_id], map: "idx_collections_user_id")
  @@index([community_id], map: "idx_collections_community_id")
  @@map("gallery_collections")
  @@schema("public")
}

// Пост с HTML контентом и ценой
model gallery_posts {
  id              BigInt            @id @default(autoincrement())
  title           String?
  thumbnail_url   String?
  content_html    String
  price           Decimal?          @db.Decimal(10, 2)
  currency        String            @default("RUB")
  collection_id   BigInt
  user_id         String            @db.Uuid
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)

  collection      gallery_collections @relation(fields: [collection_id], references: [id], onDelete: Cascade)
  orders         orders[]

  @@index([collection_id], map: "idx_posts_collection_id")
  @@index([user_id], map: "idx_posts_user_id")
  @@map("gallery_posts")
  @@schema("public")
}

// Фото с ценой и описанием
model gallery_photos {
  id            BigInt            @id @default(autoincrement())
  url           String
  description   String?
  price         Decimal?          @db.Decimal(10, 2)
  currency      String            @default("RUB")
  collection_id BigInt
  user_id       String            @db.Uuid
  created_at    DateTime          @default(now()) @db.Timestamptz(6)

  collection    gallery_collections @relation(fields: [collection_id], references: [id], onDelete: Cascade)
  orders        orders[]

  @@index([collection_id], map: "idx_photos_collection_id")
  @@index([user_id], map: "idx_photos_user_id")
  @@map("gallery_photos")
  @@schema("public")
}

// Аудио-треки для коллекции
enum gallery_playback_mode {
  repeat_one
  repeat_all
  mix

  @@schema("public")
}

model gallery_audio {
  id            BigInt              @id @default(autoincrement())
  url           String
  title         String?
  playback_mode gallery_playback_mode @default(repeat_all)
  collection_id BigInt
  created_at    DateTime            @default(now()) @db.Timestamptz(6)

  collection    gallery_collections @relation(fields: [collection_id], references: [id], onDelete: Cascade)

  @@index([collection_id], map: "idx_audio_collection_id")
  @@map("gallery_audio")
  @@schema("public")
}

// Статус заказа
enum order_status {
  new
  paid
  delivery
  delivered
  archived

  @@schema("public")
}

// Заказы
model orders {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String        @db.Uuid
  created_at    DateTime      @default(now()) @db.Timestamptz(6)
  
  // Ссылка на фото или пост
  photo_id      BigInt?
  post_id       BigInt?
  
  // Товар
  price         Decimal       @db.Decimal(10, 2)
  currency      String        @default("RUB")
  quantity      Int           @default(1)
  options       String?       // JSON строка с опциями товара
  
  // Статус
  status        order_status  @default(new)
  status_changed_at DateTime?  @db.Timestamptz(6)
  
  // Контактные данные
  address       String?
  phone         String?
  email         String?
  comment       String?
  
  photo         gallery_photos? @relation(fields: [photo_id], references: [id], onDelete: SetNull)
  post          gallery_posts?  @relation(fields: [post_id], references: [id], onDelete: SetNull)

  @@index([user_id], map: "idx_orders_user_id")
  @@index([status], map: "idx_orders_status")
  @@index([created_at], map: "idx_orders_created_at")
  @@map("orders")
  @@schema("public")
}
